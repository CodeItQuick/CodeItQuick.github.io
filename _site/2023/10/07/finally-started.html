<h1 id="finally-starting-a-learning-journal">Finally starting a learning journal</h1>

<p>I started with a code snippet trying to implement finally using some fetching logic on a react project.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">someReactQueryOrJavascriptWhatever</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nx">results</span><span class="p">;</span>
   <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="nx">results</span> <span class="o">=</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">stuff</span><span class="dl">'</span><span class="p">).</span><span class="nf">then</span><span class="p">().</span><span class="k">catch</span><span class="p">();</span>
   <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
      <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">results</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="whats-wrong-with-this-code">What’s wrong with this code?</h2>

<p>Well - if I double click the code, for example, the spinner will never resolve. I’ll get an infinite spin, and depending on the logic
I’m using, the button/etc. could be disabled. Terrible result. But Why? Well the promise is actually returned in the result, and the finally executes
immediately. My intention was to do a fetch, and then do any cleanup necessary (eg: refresh the page and remove the spinner).</p>

<p>After contacting my local javascript finally wizards (Juan in trashdevs discord, and Mark in my local dev community) I discovered the way. Which is succinctly put:</p>

<h3 id="faction-one-try-catch-finally">Faction One (Try-Catch-Finally)</h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">someReactQueryOrJavascriptWhatever</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">stuff</span><span class="dl">'</span><span class="p">);</span>
        <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">response</span><span class="p">.</span><span class="nf">json</span><span class="p">();</span>
        <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed to fetch 'stuff':</span><span class="dl">"</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
        <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code can also be re-written (yet again) to use a then/catch promise syntax. Something like (and this is me so forgive me for my mistakes):</p>

<h3 id="faction-two-thencatch">Faction Two (Then/Catch)</h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">someReactQueryOrJavascriptWhatever</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">stuff</span><span class="dl">'</span><span class="p">).</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
        <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
        <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Which is better? I’ll let you decide, the second has duplicate code but is “shorter”, the first is a bit more verbose/maybe more intention revealing.</p>

<h3 id="also-a-common-gotchya-in-try-catch-finally-land">Also a common gotchya in try catch finally land</h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">myfunc</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">try</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
   <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will return true, then return false. Very weird behaviour, so a do-not-attempt-in-real-life kind of code smell.</p>

<h2 id="debounced-solution-credit-mark">Debounced Solution (Credit: Mark)</h2>

<p>Wrap the function with the below to stop it executing twice when undesired:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">debounce</span> <span class="o">=</span> <span class="p">(</span><span class="nx">func</span><span class="p">,</span> <span class="nx">delay</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">timeoutId</span>
  <span class="k">return </span><span class="p">(...</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">clearTimeout</span><span class="p">(</span><span class="nx">timeoutId</span><span class="p">)</span>
    <span class="nx">timeoutId</span> <span class="o">=</span> <span class="nf">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nf">func</span><span class="p">(...</span><span class="nx">args</span><span class="p">),</span> <span class="nx">delay</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="faction-three-no-try-catch">Faction THREE: No try catch</h2>

<p>Instead of relying on throwing and catch errors in place, use type safety to handle success vs error cases.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">someReactQueryOrJavascriptWhatever</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">fetch</span><span class="p">(</span><span class="dl">'</span><span class="s1">stuff</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
        <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        <span class="c1">// do error case</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">pageData</span><span class="p">.</span><span class="nf">refetch</span><span class="p">();</span>
    <span class="nf">setSpinner</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="c1">// do success case</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The above is more interesting with typescript - where we can codify error responses as an “error type” and success responses as a “success type”.</p>

<p>For example:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">SuccessType</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span> 
   <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">success</span><span class="dl">'</span><span class="p">;</span>
   <span class="nl">data</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">ErrorType</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">;</span>
  <span class="nl">errNo</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p><a href="/blog_list.html">Take me to the blog</a></p>
